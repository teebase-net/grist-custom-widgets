<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { 
      --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; 
      --item-bg: #fdffdf; /* Access-style light yellow */
    }
    body.dark { 
      --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; 
    }
    body { 
      font-family: -apple-system, Segoe UI, sans-serif; 
      margin: 0; padding: 12px; background: var(--bg); color: var(--text); 
      scrollbar-width: none;
    }
    .toolbar { display: flex; justify-content: flex-end; margin-bottom: 10px; min-height: 24px; }
    .sync-btn { 
      display: none; font-size: 10px; cursor: pointer; padding: 4px 10px; border: 1px solid var(--border); 
      border-radius: 4px; background: var(--item-bg); color: var(--primary); font-weight: bold;
      text-transform: uppercase; box-shadow: 1px 1px 0px var(--border);
    }
    .sync-btn:hover { background: var(--primary); color: white; }

    .grid { display: grid; gap: 12px; grid-template-columns: repeat(var(--cols, 3), 1fr); }
    .section-header { 
      grid-column: 1 / -1; font-size: 11px; font-weight: 800; color: var(--primary); 
      text-transform: uppercase; margin-top: 18px; border-bottom: 2px solid var(--border); padding-bottom: 4px;
    }
    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px;
      padding: 16px 10px; text-align: center; cursor: pointer; text-decoration: none; color: inherit;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.1s; box-shadow: 1px 1px 0px var(--border);
    }
    .menu-item:hover { border-color: var(--primary); transform: translate(-1px, -1px); box-shadow: 3px 3px 0px var(--primary); }
    .label { font-size: 13px; font-weight: 600; line-height: 1.3; }
  </style>
</head>
<body>
  <div class="toolbar"><div id="admin-sync" class="sync-btn" onclick="syncMetadata()">ðŸ”„ Sync System Pages</div></div>
  <div id="main" class="grid">Initializing...</div>

  <script>
    grist.ready({ requiredAccess: 'full' });

    async function checkAdminStatus() {
      try {
        const table = await grist.docApi.fetchTable('SysUsers');
        const user = await grist.docApi.getDocMeta().then(m => m.users[0].email.toLowerCase());
        const idx = table.Email.findIndex(e => e.toLowerCase() === user);
        if (idx !== -1 && table.Unlock_Structure[idx]) {
          document.getElementById('admin-sync').style.display = 'block';
        }
      } catch (e) { console.warn("Admin check: Access to SysUsers denied or table missing."); }
    }

    async function syncMetadata() {
      try {
        const docId = await grist.docApi.getDocName();
        const sysPages = await grist.docApi.fetchTable('_grist_Pages');
        const sysViews = await grist.docApi.fetchTable('_grist_Views');
        let existing = { Link: [] };
        try { existing = await grist.docApi.fetchTable('SysNavigationMenu'); } catch(e) {}

        const links = new Set(existing.Link || []);
        const toAdd = { Section: [], Label: [], Link: [], Sort_Order: [], Columns: [] };

        sysPages.id.forEach((pid, i) => {
          const vName = sysViews.name[sysViews.id.indexOf(sysPages.viewRef[i])];
          const link = `/doc/${docId}/p/${pid}`;
          if (vName && !vName.startsWith('Grist') && !links.has(link)) {
            toAdd.Section.push("UNASSIGNED ðŸ› ï¸");
            toAdd.Label.push(vName);
            toAdd.Link.push(link);
            toAdd.Sort_Order.push(999);
            toAdd.Columns.push(3);
          }
        });

        if (toAdd.Label.length > 0) {
          await grist.docApi.addRecords('SysNavigationMenu', toAdd);
          alert(`Success! Sync added ${toAdd.Label.length} pages.`);
          buildMenu();
        } else { alert("All pages are already in SysNavigationMenu."); }
      } catch (e) { alert("Sync failed. Check Full Access."); }
    }

    async function buildMenu() {
      try {
        await checkAdminStatus();
        const docId = await grist.docApi.getDocName();
        const sysPages = await grist.docApi.fetchTable('_grist_Pages');
        const sysViews = await grist.docApi.fetchTable('_grist_Views');
        let overrides = { id: [] };
        try { overrides = await grist.docApi.fetchTable('SysNavigationMenu'); } catch(e) {}

        const main = document.getElementById('main');
        main.innerHTML = '';
        const groups = {};
        const handled = new Set();

        if (overrides.id?.length > 0) {
          document.body.style.setProperty('--cols', overrides.Columns[0] || 3);
          overrides.id.forEach((id, i) => {
            if (overrides.Section[i] === "HIDDEN") return;
            const sec = overrides.Section[i] || 'Modules';
            if (!groups[sec]) groups[sec] = [];
            groups[sec].push({ label: overrides.Label[i], link: overrides.Link[i], order: overrides.Sort_Order[i] });
            handled.add(overrides.Link[i]);
          });
        }

        sysPages.id.forEach((pid, i) => {
          const link = `/doc/${docId}/p/${pid}`;
          if (!handled.has(link)) {
            const vName = sysViews.name[sysViews.id.indexOf(sysPages.viewRef[i])];
            if (vName && !vName.startsWith('Grist')) {
              if (!groups["Uncategorized âœ¨"]) groups["Uncategorized âœ¨"] = [];
              groups["Uncategorized âœ¨"].push({ label: vName, link: link, order: 999 });
            }
          }
        });

        Object.keys(groups).sort().forEach(sec => {
          const h = document.createElement('div'); h.className = 'section-header'; h.innerHTML = sec;
          main.appendChild(h);
          groups[sec].sort((a,b) => a.order - b.order).forEach(item => {
            const a = document.createElement('a'); a.className = 'menu-item'; a.href = item.link; a.target = '_top';
            a.innerHTML = `<div class="label">${item.label}</div>`;
            main.appendChild(a);
          });
        });
      } catch (e) { main.innerHTML = "Configuration Required: Set to 'Full Access'."; }
    }

    grist.onOptions(o => { if (o.appearance === 'dark') document.body.classList.add('dark'); });
    buildMenu();
  </script>
</body>
</html>
