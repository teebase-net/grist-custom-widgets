<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #fdffdf; --cols: 3; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    
    body { 
      font-family: -apple-system, system-ui, sans-serif; 
      margin: 0; padding: 10px; 
      background: var(--bg); color: var(--text);
      /* Force GPU for entire body to prevent painting lag */
      transform: translateZ(0);
    }

    .toolbar { display: flex; justify-content: flex-end; height: 20px; margin-bottom: 8px; }
    .sync-btn { 
      font-size: 9px; cursor: pointer; border: 1px solid var(--border); 
      background: var(--item-bg); color: var(--primary); font-weight: bold; padding: 2px 6px;
    }

    /* Fixed Grid to prevent jumping */
    #main { 
      display: grid; 
      gap: 10px; 
      grid-template-columns: repeat(var(--cols), 1fr);
      min-height: 100vh; /* Keeps height consistent */
    }

    .section-header { 
      grid-column: 1 / -1; font-size: 10px; font-weight: 800; 
      color: var(--primary); text-transform: uppercase; 
      margin-top: 10px; border-bottom: 1px solid var(--border);
    }

    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px; 
      padding: 12px 8px; text-align: center; text-decoration: none; color: inherit;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      contain: content; /* Senior optimization: prevents internal changes from affecting outer layout */
    }

    .menu-item:hover { background: var(--bg); border-color: var(--primary); }
    .label { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; }
  </style>
</head>
<body>
  <div class="toolbar"><button id="admin-sync" class="sync-btn" style="display:none" onclick="runSync()">Sync</button></div>
  <div id="main"></div>

  <script>
    const GristOrigin = "https://dev.teebase.net";
    const CACHE_KEY = "grist_menu_cache";

    // 1. INSTANT HYDRATION
    // Load from local storage before the API even starts
    function hydrate() {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        render(JSON.parse(cached));
      }
    }

    function render(records) {
      if (!records || !records.length) return;
      
      const main = document.getElementById('main');
      const fragment = document.createDocumentFragment();
      const groups = {};

      // Set columns instantly
      document.documentElement.style.setProperty('--cols', records[0].GridColumns || 3);

      records.forEach(rec => {
        if (rec.Section === "HIDDEN") return;
        const sec = rec.Section || 'Menu';
        if (!groups[sec]) groups[sec] = [];
        groups[sec].push(rec);
      });

      Object.keys(groups).sort().forEach(sec => {
        const h = document.createElement('div');
        h.className = 'section-header';
        h.textContent = sec;
        fragment.appendChild(h);

        groups[sec].sort((a,b) => (a.Sort_Order || 99) - (b.Sort_Order || 99)).forEach(item => {
          const a = document.createElement('a');
          a.className = 'menu-item';
          const path = item.Link.startsWith('/') ? item.Link : '/' + item.Link;
          a.href = item.Link.startsWith('http') ? item.Link : GristOrigin + path;
          a.target = '_top';
          a.innerHTML = `<div class="label">${item.Label}</div>`;
          fragment.appendChild(a);
        });
      });

      main.innerHTML = '';
      main.appendChild(fragment);
    }

    // 2. BACKGROUND API SYNC
    grist.ready({
      requiredAccess: 'full',
      columns: ["Section", "Label", "Link", "Sort_Order", "GridColumns"]
    });

    grist.onRecords((records) => {
      // Save to cache for next load
      localStorage.setItem(CACHE_KEY, JSON.stringify(records));
      // Re-render only if data has actually changed (prevents flickers)
      render(records);
    });

    // Check Admin in background
    grist.on('message', (msg) => {
      if (msg.tableId === 'SysUsers' || msg.docInfo) {
        grist.docApi.fetchTable('SysUsers').then(u => {
          if (u.Unlock_Structure.some(v => v === true)) document.getElementById('admin-sync').style.display = 'block';
        }).catch(() => {});
      }
    });

    async function runSync() {
      try {
        const [sysPages, sysViews, docId] = await Promise.all([
          grist.docApi.fetchTable('_grist_Pages'),
          grist.docApi.fetchTable('_grist_Views'),
          grist.docApi.getDocName()
        ]);
        const actions = sysPages.id.map((pid, i) => {
          const vName = sysViews.name[sysViews.id.indexOf(sysPages.viewRef[i])];
          return (vName && !vName.startsWith('Grist')) ? 
            ["AddRecord", "SysNavigationMenu", null, { 
              Section: "NEW ðŸ› ï¸", Label: String(vName), 
              Link: `/doc/${docId}/p/${pid}`, 
              Sort_Order: 999, GridColumns: 3 
            }] : null;
        }).filter(a => a);
        if (actions.length) await grist.docApi.applyUserActions(actions);
      } catch (e) { console.error(e); }
    }

    // Initialize
    hydrate();
  </script>
</body>
</html>
