<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #fdffdf; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); }
    
    /* Hardware acceleration for smoother transitions */
    .menu-item { will-change: transform, box-shadow; transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; }
    
    .toolbar { display: flex; justify-content: flex-end; margin-bottom: 12px; }
    .sync-btn { font-size: 10px; cursor: pointer; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--item-bg); color: var(--primary); font-weight: bold; text-transform: uppercase; }
    
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(var(--cols, 3), 1fr); }
    .section-header { grid-column: 1 / -1; font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-top: 15px; border-bottom: 2px solid var(--border); padding-bottom: 4px; letter-spacing: 0.5px; }
    
    .menu-item { background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px; padding: 14px 10px; text-align: center; cursor: pointer; text-decoration: none; color: inherit; display: flex; flex-direction: column; box-shadow: 1px 1px 0px var(--border); }
    .menu-item:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 2px 2px 0px var(--primary); }
    .label { font-size: 13px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    #main.loading { opacity: 0.5; filter: blur(1px); }
  </style>
</head>
<body>
  <div class="toolbar"><button id="admin-sync" class="sync-btn" style="display:none" onclick="runSync()">ðŸ”„ Sync</button></div>
  <div id="main" class="grid"></div>

  <script>
    const GristOrigin = "https://dev.teebase.net";
    let cachedDocId = null;

    // Initialize Widget with explicit column requirements
    grist.ready({
      requiredAccess: 'full',
      columns: ["Section", "Label", "Link", "Sort_Order", "GridColumns"]
    });

    // REACTIVE UPDATE: This triggers instantly when Grist data changes
    grist.onRecords((records) => {
      const main = document.getElementById('main');
      if (!records || records.length === 0) {
        main.innerHTML = "<div>Menu empty. Run Sync.</div>";
        return;
      }

      // 1. Set Grid Config
      const gridCols = records[0].GridColumns || 3;
      document.body.style.setProperty('--cols', gridCols);

      // 2. Build Fragment (In-memory) to prevent flicker
      const fragment = document.createDocumentFragment();
      const groups = {};

      records.forEach(rec => {
        if (rec.Section === "HIDDEN") return;
        const sec = rec.Section || 'General';
        if (!groups[sec]) groups[sec] = [];
        groups[sec].push(rec);
      });

      Object.keys(groups).sort().forEach(sec => {
        const h = document.createElement('div');
        h.className = 'section-header';
        h.textContent = sec;
        fragment.appendChild(h);

        groups[sec].sort((a,b) => (a.Sort_Order || 999) - (b.Sort_Order || 999)).forEach(item => {
          const a = document.createElement('a');
          a.className = 'menu-item';
          const path = item.Link.startsWith('/') ? item.Link : '/' + item.Link;
          a.href = item.Link.startsWith('http') ? item.Link : GristOrigin + path;
          a.target = '_top';
          a.innerHTML = `<div class="label">${item.Label}</div>`;
          fragment.appendChild(a);
        });
      });

      // 3. Single DOM Swap
      main.innerHTML = '';
      main.appendChild(fragment);
      main.classList.remove('loading');
    });

    // Check Admin Status once on load
    grist.on('message', (msg) => {
      if (msg.tableId === 'SysUsers' || msg.docInfo) {
        grist.docApi.fetchTable('SysUsers').then(users => {
           if (users.Unlock_Structure.some(v => v === true)) {
             document.getElementById('admin-sync').style.display = 'block';
           }
        }).catch(() => {});
      }
    });

    async function runSync() {
      const btn = document.getElementById('admin-sync');
      try {
        btn.innerText = "Syncing...";
        const [sysPages, sysViews, docId] = await Promise.all([
          grist.docApi.fetchTable('_grist_Pages'),
          grist.docApi.fetchTable('_grist_Views'),
          grist.docApi.getDocName()
        ]);
        
        const actions = [];
        sysPages.id.forEach((pid, i) => {
          const vName = sysViews.name[sysViews.id.indexOf(sysPages.viewRef[i])];
          if (vName && !vName.startsWith('Grist')) {
            actions.push(["AddRecord", "SysNavigationMenu", null, {
              Section: "NEW ðŸ› ï¸",
              Label: String(vName),
              Link: `/doc/${docId}/p/${pid}`,
              Sort_Order: 999,
              GridColumns: 3
            }]);
          }
        });

        if (actions.length > 0) {
          await grist.docApi.applyUserActions(actions);
        }
      } catch (e) {
        alert(`Sync Error: ${e.message}`);
      } finally {
        btn.innerText = "ðŸ”„ Sync";
      }
    }
  </script>
</body>
</html>
