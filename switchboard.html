<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #fdffdf; --cols: 3; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: var(--text); overflow-x: hidden; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .v-tag { font-size: 8px; color: #2ecc71; border: 1px solid #2ecc71; padding: 1px 4px; border-radius: 3px; font-weight: bold; }
    .sync-btn { font-size: 9px; cursor: pointer; border: 1px solid var(--border); background: var(--item-bg); color: var(--primary); font-weight: bold; padding: 2px 6px; display: none; }

    #main { display: grid; gap: 8px; grid-template-columns: repeat(var(--cols), 1fr); }
    .section-header { grid-column: 1 / -1; font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-top: 8px; border-bottom: 1px solid var(--border); }

    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px; 
      padding: 12px 6px; text-align: center; cursor: pointer; transition: all 0.1s;
    }
    .menu-item:hover { background: var(--bg); border-color: var(--primary); transform: translateY(-1px); }
    .label { font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    #log { font-size: 8px; color: #999; margin-top: 10px; font-family: monospace; border-top: 1px solid #eee; padding-top: 4px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <span class="v-tag">v1.1.0-ULTRA</span>
    <button id="admin-sync" class="sync-btn" onclick="runSync()">RE-SYNC PAGES</button>
  </div>
  <div id="main"></div>
  <div id="log">Status: Initializing...</div>

  <script>
    const CACHE_KEY = "grist_switchboard_v1";
    const status = (m) => document.getElementById('log').innerText = "Status: " + m;

    function render(records) {
      const main = document.getElementById('main');
      if (!records || !records.length) { status("No data."); return; }
      
      document.documentElement.style.setProperty('--cols', records[0].GridColumns || 3);
      const frag = document.createDocumentFragment();
      const groups = {};

      records.forEach(r => {
        if (r.Section === "HIDDEN") return;
        const s = r.Section || 'Menu';
        if (!groups[s]) groups[s] = [];
        groups[s].push(r);
      });

      Object.keys(groups).sort().forEach(s => {
        const h = document.createElement('div'); h.className = 'section-header'; h.textContent = s;
        frag.appendChild(h);
        groups[s].sort((a,b) => (a.Sort_Order || 99) - (b.Sort_Order || 99)).forEach(item => {
          const btn = document.createElement('div');
          btn.className = 'menu-item';
          btn.innerHTML = `<div class="label">${item.Label}</div>`;
          
          btn.onclick = () => {
            const match = item.Link.match(/\/p\/(\d+)/);
            if (match) {
              const pId = parseInt(match[1]);
              status("Pivoting to Page " + pId);
              // NATIVE NAVIGATION: No reload, instant swap
              grist.setCursor({ pageId: pId }).catch(e => {
                 status("Nav Error. Force reload...");
                 window.open(item.Link, '_top');
              });
            } else {
              window.open(item.Link, '_top');
            }
          };
          frag.appendChild(btn);
        });
      });
      main.innerHTML = ''; main.appendChild(frag);
    }

    grist.ready({ requiredAccess: 'full', columns: ["Section", "Label", "Link", "Sort_Order", "GridColumns"] });

    grist.onRecords((recs) => {
      status("Connected to Grist.");
      localStorage.setItem(CACHE_KEY, JSON.stringify(recs));
      render(recs);
    });

    // Check for admin permission to show Sync button
    grist.on('message', () => {
      grist.docApi.fetchTable('SysUsers').then(u => {
        if (u.Unlock_Structure.some(v => v === true)) document.getElementById('admin-sync').style.display = 'block';
      }).catch(() => {});
    });

    async function runSync() {
      status("Syncing tables...");
      try {
        const [pages, views, docId] = await Promise.all([
          grist.docApi.fetchTable('_grist_Pages'),
          grist.docApi.fetchTable('_grist_Views'),
          grist.docApi.getDocName()
        ]);
        const acts = pages.id.map((pid, i) => {
          const v = views.name[views.id.indexOf(pages.viewRef[i])];
          return (v && !v.startsWith('Grist')) ? ["AddRecord", "SysNavigationMenu", null, { 
            Section: "NEW", Label: String(v), Link: `/doc/${docId}/p/${pid}`, Sort_Order: 999, GridColumns: 3 
          }] : null;
        }).filter(a => a);
        if (acts.length) await grist.docApi.applyUserActions(acts);
        status("Sync Complete!");
      } catch (e) { status("Sync Error: " + e.message); }
    }

    // Immediate Boot from Cache
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) render(JSON.parse(cached));
  </script>
</body>
</html>
