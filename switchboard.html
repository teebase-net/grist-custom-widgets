<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #fdffdf; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    body { font-family: -apple-system, Segoe UI, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); overflow-x: hidden; }
    
    .toolbar { display: flex; justify-content: flex-end; margin-bottom: 12px; min-height: 24px; }
    .sync-btn { 
       font-size: 11px; cursor: pointer; padding: 5px 10px; border: 1px solid var(--border); 
       border-radius: 4px; background: var(--item-bg); color: var(--primary); font-weight: bold;
       text-transform: uppercase; box-shadow: 1px 1px 0px var(--border);
    }
    .sync-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

    .grid { display: grid; gap: 12px; grid-template-columns: repeat(var(--cols, 3), 1fr); }
    .section-header { 
      grid-column: 1 / -1; font-size: 11px; font-weight: 800; color: var(--primary); 
      text-transform: uppercase; margin-top: 15px; border-bottom: 2px solid var(--border); padding-bottom: 4px;
    }
    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px;
      padding: 14px 10px; text-align: center; cursor: pointer; text-decoration: none; color: inherit;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.1s; box-shadow: 1px 1px 0px var(--border);
    }
    .menu-item:hover { border-color: var(--primary); transform: translate(-1px, -1px); box-shadow: 3px 3px 0px var(--primary); }
    .label { font-size: 13px; font-weight: 600; line-height: 1.3; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="admin-sync" class="sync-btn" onclick="runSync()">ðŸ”„ Sync System Pages</button>
  </div>
  <div id="main" class="grid">Loading Menu...</div>

  <script>
    let currentDocId = "";
    let baseUrl = "";

    grist.ready({
      requiredAccess: 'full',
      columns: ["Section", "Label", "Link", "Sort_Order", "Columns"]
    });

    // Detect environment and build menu
    grist.onRecords(async (records) => {
      try {
        const info = await grist.docApi.getDocMeta();
        currentDocId = await grist.docApi.getDocName();
        // Force the parent domain (e.g., https://dev.teebase.net)
        baseUrl = window.location.ancestorOrigins ? window.location.ancestorOrigins[0] : window.location.origin;

        const main = document.getElementById('main');
        if (!records || records.length === 0) {
          main.innerHTML = "<div>Menu table is empty. Click <b>Sync System Pages</b> above to populate it.</div>";
          return;
        }

        document.body.style.setProperty('--cols', records[0].Columns || 3);
        main.innerHTML = '';
        const groups = {};

        records.forEach(rec => {
          if (rec.Section === "HIDDEN" || !rec.Label) return;
          const sec = rec.Section || 'General';
          if (!groups[sec]) groups[sec] = [];
          groups[sec].push(rec);
        });

        Object.keys(groups).sort().forEach(sec => {
          const h = document.createElement('div'); h.className = 'section-header'; h.innerHTML = sec;
          main.appendChild(h);
          
          groups[sec].sort((a,b) => (a.Sort_Order || 99) - (b.Sort_Order || 99)).forEach(item => {
            const a = document.createElement('a');
            a.className = 'menu-item';
            // Construct absolute link to dev.teebase.net
            const path = item.Link.startsWith('/') ? item.Link : '/' + item.Link;
            a.href = item.Link.startsWith('http') ? item.Link : baseUrl + path;
            a.target = '_top';
            a.innerHTML = `<div class="label">${item.Label}</div>`;
            main.appendChild(a);
          });
        });
      } catch (e) {
        console.error("Layout error:", e);
      }
    });

    async function runSync() {
      const btn = document.getElementById('admin-sync');
      try {
        btn.innerText = "Syncing...";
        const sysPages = await grist.docApi.fetchTable('_grist_Pages');
        const sysViews = await grist.docApi.fetchTable('_grist_Views');
        
        const toAdd = { Section: [], Label: [], Link: [], Sort_Order: [], Columns: [] };

        sysPages.id.forEach((pid, i) => {
          const vRef = sysPages.viewRef[i];
          const vIdx = sysViews.id.indexOf(vRef);
          const vName = sysViews.name[vIdx];
          
          if (vName && !vName.startsWith('Grist')) {
            toAdd.Section.push("NEW ðŸ› ï¸");
            toAdd.Label.push(vName);
            toAdd.Link.push(`/p/${pid}`);
            toAdd.Sort_Order.push(999);
            toAdd.Columns.push(4);
          }
        });

        if (toAdd.Label.length > 0) {
          await grist.docApi.addRecords('SysNavigationMenu', toAdd);
          alert(`Success! Added ${toAdd.Label.length} items to SysNavigationMenu.`);
        } else {
          alert("No new pages found to sync.");
        }
      } catch (e) {
        alert("Sync Error: " + e.message);
      } finally {
        btn.innerText = "ðŸ”„ Sync System Pages";
      }
    }
  </script>
</body>
</html>
