<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #f9f9f9; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(var(--cols, 3), 1fr); }
    
    .section-header { 
      grid-column: 1 / -1; font-size: 11px; font-weight: bold; color: var(--primary); 
      text-transform: uppercase; margin-top: 15px; border-bottom: 1px solid var(--border); padding-bottom: 4px;
    }
    
    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 6px; 
      padding: 12px 8px; text-align: center; cursor: pointer; text-decoration: none; color: inherit;
      display: flex; flex-direction: column; align-items: center; transition: all 0.2s;
    }
    .menu-item:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .icon { font-size: 20px; margin-bottom: 5px; }
    .label { font-size: 12px; font-weight: 600; line-height: 1.2; }
  </style>
</head>
<body>
  <div id="main" class="grid"></div>

  <script>
    grist.ready({ requiredAccess: 'full' });

    async function buildMenu() {
      try {
        const docId = await grist.docApi.getDocName();
        const main = document.getElementById('main');
        
        // 1. Fetch System Pages Metadata
        const sysPages = await grist.docApi.fetchTable('_grist_Pages');
        const sysViews = await grist.docApi.fetchTable('_grist_Views');
        
        // 2. Fetch Your Custom Overrides (SysNavigationMenu)
        // Note: We use try/catch in case the table doesn't exist yet
        let overrides = [];
        try { overrides = await grist.docApi.fetchTable('SysNavigationMenu'); } catch(e) { console.log("No SysNavigationMenu found yet."); }

        main.innerHTML = '';
        const groups = {};
        const handledPageIds = new Set();

        // 3. Process Overrides First (Categorized)
        if (overrides.id) {
          overrides.id.forEach((id, i) => {
            const section = overrides.Section[i] || 'General';
            if (!groups[section]) groups[section] = [];
            groups[section].push({
              label: overrides.Label[i],
              link: overrides.Link[i],
              icon: overrides.Icon[i] || 'ðŸ“‚',
              order: overrides.Sort_Order[i] || 99
            });
            // Extract Page ID from the link to track what we've covered
            const match = overrides.Link[i].match(/\/p\/(\d+)/);
            if (match) handledPageIds.add(parseInt(match[1]));
          });
        }

        // 4. Process System Pages (The Safety Net)
        sysPages.id.forEach((pageId, i) => {
          if (!handledPageIds.has(pageId)) {
            const viewRef = sysPages.viewRef[i];
            const vIdx = sysViews.id.indexOf(viewRef);
            const viewName = sysViews.name[vIdx];

            if (viewName && !viewName.startsWith('Grist')) {
              const section = "Uncategorized âœ¨";
              if (!groups[section]) groups[section] = [];
              groups[section].push({
                label: viewName,
                link: `/doc/${docId}/p/${pageId}`,
                icon: 'ðŸ“„',
                order: 999
              });
            }
          }
        });

        // 5. Render to UI
        for (const section in groups) {
          const header = document.createElement('div');
          header.className = 'section-header';
          header.textContent = section;
          main.appendChild(header);

          groups[section].sort((a,b) => a.order - b.order).forEach(item => {
            const btn = document.createElement('a');
            btn.className = 'menu-item';
            btn.href = item.link;
            btn.target = '_top';
            btn.innerHTML = `<div class="icon">${item.icon}</div><div class="label">${item.label}</div>`;
            main.appendChild(btn);
          });
        }
      } catch (err) {
        document.getElementById('main').innerHTML = "Error loading menu. Ensure 'Full Access' is enabled.";
      }
    }

    grist.onOptions((opts) => { if (opts.appearance === 'dark') document.body.classList.add('dark'); });
    buildMenu();
    // Refresh when document structure might have changed
    setInterval(buildMenu, 30000); 
  </script>
</body>
</html>
