<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: monospace; background: #222; color: #0f0; padding: 20px; font-size: 12px; line-height: 1.5; }
    .error { color: #f00; font-weight: bold; }
    .success { color: #0f0; }
    .warning { color: #ffa500; }
    hr { border: 0; border-top: 1px solid #444; margin: 10px 0; }
  </style>
</head>
<body>
  <div>[ SYSTEM DIAGNOSTICS RUNNING ]</div>
  <hr>
  <div id="log"></div>

  <script>
    function log(msg, type = '') {
      const div = document.createElement('div');
      div.className = type;
      div.innerText = `> ${msg}`;
      document.getElementById('log').appendChild(div);
      console.log(`[Diagnostic] ${msg}`);
    }

    async function runDiagnostics() {
      log("Initializing Grist API handshake...");
      
      try {
        await grist.ready({ requiredAccess: 'full' });
        log("Grist Ready confirmed.", "success");
      } catch (e) {
        log("Grist Ready failed: " + e.message, "error");
      }

      // Check Document Metadata
      try {
        const meta = await grist.docApi.getDocMeta();
        log("Metadata access: GRANTED", "success");
        log("Current User: " + meta.users[0].email);
      } catch (e) {
        log("Metadata access: DENIED (Usually means Access Level is not 'Full')", "error");
      }

      // Check Domain/Origin
      log("Widget URL: " + window.location.href);
      log("Parent Origin: " + (window.location.ancestorOrigins ? window.location.ancestorOrigins[0] : "Not found"));

      // Test Table Access: SysNavigationMenu
      try {
        log("Testing access to 'SysNavigationMenu'...");
        const table = await grist.docApi.fetchTable('SysNavigationMenu');
        log(`Success! Found ${table.id.length} records.`, "success");
      } catch (e) {
        log("Access to 'SysNavigationMenu' failed: " + e.message, "error");
      }

      // Test Table Access: SysUsers
      try {
        log("Testing access to 'SysUsers'...");
        const users = await grist.docApi.fetchTable('SysUsers');
        log(`Success! Found ${users.id.length} users.`, "success");
      } catch (e) {
        log("Access to 'SysUsers' failed: " + e.message, "error");
      }

      // Test System Metadata Access
      try {
        log("Testing access to internal '_grist_Pages'...");
        const pages = await grist.docApi.fetchTable('_grist_Pages');
        log(`Success! Found ${pages.id.length} internal pages.`, "success");
      } catch (e) {
        log("Access to '_grist_Pages' failed. (This is common if not truly 'Full Access')", "error");
      }
    }

    runDiagnostics();
  </script>
</body>
</html>
