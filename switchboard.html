<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { --primary: #5dade2; --bg: #ffffff; --text: #333; --border: #ddd; --item-bg: #fdffdf; --active: #f1c40f; --cols: 3; }
    body.dark { --bg: #1e1e1e; --text: #e8e8e8; --border: #444; --item-bg: #2c2c2c; }
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: var(--text); overflow: hidden; }
    
    .toolbar { display: flex; justify-content: flex-end; height: 18px; margin-bottom: 8px; }
    .sync-btn { font-size: 8px; cursor: pointer; border: 1px solid var(--border); background: var(--item-bg); color: var(--primary); font-weight: bold; padding: 1px 4px; opacity: 0.6; }

    #main { display: grid; gap: 10px; grid-template-columns: repeat(var(--cols), 1fr); }
    .section-header { grid-column: 1 / -1; font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-top: 10px; border-bottom: 1px solid var(--border); padding-bottom: 2px; }

    .menu-item { 
      background: var(--item-bg); border: 1px solid var(--border); border-radius: 4px; 
      padding: 12px 8px; text-align: center; color: inherit;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.1s; user-select: none;
    }
    .menu-item:hover { background: var(--bg); border-color: var(--primary); }
    .menu-item.active { border-left: 4px solid var(--active); background: var(--bg); font-weight: bold; }
    .label { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
  </style>
</head>
<body>
  <div class="toolbar"><button id="admin-sync" class="sync-btn" style="display:none" onclick="runSync()">Sync</button></div>
  <div id="main"></div>

  <script>
    const CACHE_KEY = "grist_menu_cache";
    let lastKnownHash = "";

    function render(records) {
      if (!records || !records.length) return;
      const main = document.getElementById('main');
      const fragment = document.createDocumentFragment();
      const groups = {};
      const currentHash = window.parent.location.hash;

      document.documentElement.style.setProperty('--cols', records[0].GridColumns || 3);

      records.forEach(rec => {
        if (rec.Section === "HIDDEN") return;
        const sec = rec.Section || 'Menu';
        if (!groups[sec]) groups[sec] = [];
        groups[sec].push(rec);
      });

      Object.keys(groups).sort().forEach(sec => {
        const h = document.createElement('div');
        h.className = 'section-header';
        h.textContent = sec;
        fragment.appendChild(h);

        groups[sec].sort((a,b) => (a.Sort_Order || 99) - (b.Sort_Order || 99)).forEach(item => {
          const btn = document.createElement('div');
          const pageMatch = item.Link.match(/\/p\/(\d+)/);
          const pageAnchor = pageMatch ? `p/${pageMatch[1]}` : null;
          
          btn.className = 'menu-item';
          if (pageAnchor && currentHash.includes(pageAnchor)) btn.classList.add('active');

          btn.onclick = () => {
            if (pageAnchor) {
              // SENIOR FIX: The "Hash-Only" jump.
              // Grist's internal AppController listens for hashchange events.
              // If we change ONLY the hash, the page does not reload.
              try {
                window.parent.location.hash = pageAnchor;
                
                // Visual feedback
                document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
              } catch (e) {
                // If cross-origin security blocks direct hash access, 
                // we fall back to the native Grist message bus
                grist.setCursor({ pageId: parseInt(pageMatch[1]) });
              }
            } else {
              window.open(item.Link, '_top');
            }
          };

          btn.innerHTML = `<div class="label">${item.Label}</div>`;
          fragment.appendChild(btn);
        });
      });

      main.innerHTML = '';
      main.appendChild(fragment);
    }

    grist.ready({
      requiredAccess: 'full',
      columns: ["Section", "Label", "Link", "Sort_Order", "GridColumns"]
    });

    grist.onRecords((records) => {
      localStorage.setItem(CACHE_KEY, JSON.stringify(records));
      render(records);
    });

    // Detect navigation done elsewhere in Grist to keep buttons in sync
    setInterval(() => {
      if (window.parent.location.hash !== lastKnownHash) {
        lastKnownHash = window.parent.location.hash;
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) render(JSON.parse(cached));
      }
    }, 1000);

    // Sync logic (Internal)
    async function runSync() {
      try {
        const [sysPages, sysViews, docId] = await Promise.all([
          grist.docApi.fetchTable('_grist_Pages'),
          grist.docApi.fetchTable('_grist_Views'),
          grist.docApi.getDocName()
        ]);
        const actions = sysPages.id.map((pid, i) => {
          const vName = sysViews.name[sysViews.id.indexOf(sysPages.viewRef[i])];
          return (vName && !vName.startsWith('Grist')) ? 
            ["AddRecord", "SysNavigationMenu", null, { 
              Section: "NEW ðŸ› ï¸", Label: String(vName), Link: `/doc/${docId}/p/${pid}`, 
              Sort_Order: 999, GridColumns: 3 
            }] : null;
        }).filter(a => a);
        if (actions.length) await grist.docApi.applyUserActions(actions);
      } catch (e) { console.error(e); }
    }

    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) render(JSON.parse(cached));

    grist.on('message', (msg) => {
      if (msg.tableId === 'SysUsers' || msg.docInfo) {
        grist.docApi.fetchTable('SysUsers').then(u => {
          if (u.Unlock_Structure.some(v => v === true)) document.getElementById('admin-sync').style.display = 'block';
        }).catch(() => {});
      }
    });
  </script>
</body>
</html>
