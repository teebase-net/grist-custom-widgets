<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root { 
      --primary: #5dade2; 
      --bg: #ffffff; 
      --text: #333; 
      --border: #ddd; 
      --item-bg: #fdffdf; /* Light yellow tint like classic Access forms */
    }
    body.dark { 
      --bg: #1e1e1e; 
      --text: #e8e8e8; 
      --border: #444; 
      --item-bg: #2c2c2c; 
    }
    
    body { 
      font-family: -apple-system, Segoe UI, sans-serif; 
      margin: 0; padding: 12px; 
      background: var(--bg); color: var(--text); 
      scrollbar-width: none;
    }
    
    .grid { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: repeat(var(--cols, 3), 1fr); 
    }
    
    .section-header { 
      grid-column: 1 / -1; 
      font-size: 12px; 
      font-weight: 800; 
      color: var(--primary); 
      text-transform: uppercase; 
      margin-top: 18px; 
      border-bottom: 2px solid var(--border); 
      padding-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    .menu-item { 
      background: var(--item-bg); 
      border: 1px solid var(--border); 
      border-radius: 4px; /* Sharper corners for a database-app feel */
      padding: 16px 10px; 
      text-align: center; 
      cursor: pointer; 
      text-decoration: none; 
      color: inherit;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      transition: all 0.1s ease-in-out;
      box-shadow: 1px 1px 0px var(--border);
    }

    .menu-item:hover { 
      border-color: var(--primary); 
      background: var(--bg);
      transform: translate(-1px, -1px);
      box-shadow: 3px 3px 0px var(--primary);
    }
    
    .label { 
      font-size: 13px; 
      font-weight: 600; 
      line-height: 1.3;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="main" class="grid">Initializing Switchboard...</div>

  <script>
    grist.ready({ requiredAccess: 'full' });

    async function buildMenu() {
      try {
        const docId = await grist.docApi.getDocName();
        const main = document.getElementById('main');
        
        // 1. Fetch System Metadata
        const sysPages = await grist.docApi.fetchTable('_grist_Pages');
        const sysViews = await grist.docApi.fetchTable('_grist_Views');
        
        // 2. Fetch User Overrides
        let overrides = { id: [] };
        try { overrides = await grist.docApi.fetchTable('SysNavigationMenu'); } catch(e) {}

        main.innerHTML = '';
        const groups = {};
        const handledPageIds = new Set();

        // 3. Process Overrides (Defined in your table)
        if (overrides.id && overrides.id.length > 0) {
          // Set grid columns based on first entry or default
          document.body.style.setProperty('--cols', overrides.Columns[0] || 3);

          overrides.id.forEach((id, i) => {
            const section = overrides.Section[i] || 'Modules';
            if (!groups[section]) groups[section] = [];
            
            groups[section].push({
              label: overrides.Label[i],
              link: overrides.Link[i],
              order: overrides.Sort_Order[i] || 99
            });

            const match = overrides.Link[i].match(/\/p\/(\d+)/);
            if (match) handledPageIds.add(parseInt(match[1]));
          });
        }

        // 4. Process Remaining System Pages (Auto-discovery)
        sysPages.id.forEach((pageId, i) => {
          if (!handledPageIds.has(pageId)) {
            const viewRef = sysPages.viewRef[i];
            const vIdx = sysViews.id.indexOf(viewRef);
            const viewName = sysViews.name[vIdx];

            if (viewName && !viewName.startsWith('Grist')) {
              const section = "Uncategorized âœ¨";
              if (!groups[section]) groups[section] = [];
              groups[section].push({
                label: viewName,
                link: `/doc/${docId}/p/${pageId}`,
                order: 999
              });
            }
          }
        });

        // 5. Render
        for (const section in groups) {
          const header = document.createElement('div');
          header.className = 'section-header';
          header.innerHTML = section; // Allows emoji in section names
          main.appendChild(header);

          groups[section].sort((a,b) => a.order - b.order).forEach(item => {
            const btn = document.createElement('a');
            btn.className = 'menu-item';
            btn.href = item.link;
            btn.target = '_top';
            btn.innerHTML = `<div class="label">${item.label}</div>`;
            main.appendChild(btn);
          });
        }
      } catch (err) {
        document.getElementById('main').innerHTML = "Ready for SysNavigationMenu mapping...";
      }
    }

    grist.onOptions((opts) => { if (opts.appearance === 'dark') document.body.classList.add('dark'); });
    buildMenu();
    // Auto-refresh every 30 seconds to catch new pages
    setInterval(buildMenu, 30000); 
  </script>
</body>
</html>
